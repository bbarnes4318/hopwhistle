#!KAMAILIO

# ==========================================================================
# Global Parameters
# ==========================================================================

# ENABLE POSTGRES INSTEAD OF MYSQL
#!define WITH_POSTGRES
#!define WITH_AUTH
#!define WITH_USRLOCDB
#!define WITH_NAT
#!define WITH_ANTIFLOOD

# Log Level: 3=MI, 2=NOTICE, 1=WARN, 0=ERR
debug=2
log_stderror=no
log_facility=LOG_LOCAL0

# SIP Ports
port=5060

# -----------------
# TCP Configuration
# -----------------
disable_tcp=no
tcp_children=4
tcp_connection_lifetime=3605
tcp_max_connections=2048

# -----------------
# DNS Configuration
# -----------------
dns=yes
rev_dns=no
dns_try_ipv6=no
use_dns_cache=yes
dns_cache_init=yes
dns_use_search_list=no

# -----------------
# Listeners
# -----------------
# We listen on all interfaces but advertise the Public IP
# The 'PUBLIC_IP' string is replaced by entrypoint.sh at runtime
listen=udp:0.0.0.0:5060 advertise PUBLIC_IP:5060
listen=tcp:0.0.0.0:5060 advertise PUBLIC_IP:5060

# ==========================================================================
# Modules
# ==========================================================================

mpath="/usr/lib/x86_64-linux-gnu/kamailio/modules/"

# Load PostgreSQL module instead of MySQL
loadmodule "db_postgres.so"
loadmodule "jsonrpcs.so"
loadmodule "kex.so"
loadmodule "corex.so"
loadmodule "tm.so"
loadmodule "tmx.so"
loadmodule "sl.so"
loadmodule "rr.so"
loadmodule "pv.so"
loadmodule "maxfwd.so"
loadmodule "usrloc.so"
loadmodule "registrar.so"
loadmodule "textops.so"
loadmodule "siputils.so"
loadmodule "xlog.so"
loadmodule "sanity.so"
loadmodule "ctl.so"
loadmodule "cfg_rpc.so"
loadmodule "dispatcher.so"
loadmodule "nathelper.so"
loadmodule "rtpengine.so"

# ==========================================================================
# Database URL Setup
# ==========================================================================
# This acts as a default if not overridden by env vars in some modules
# But for dynamic DB usage, Kamailio uses the modparams below

# ==========================================================================
# Module Parameters
# ==========================================================================

# --- Auth / USRLoc / DB ---
# Ensure these point to the DB URL provided by environment (handled by core usually)
# Or set specifically if using specific DB modules directly

# --- TM ---
modparam("tm", "auto_inv_100", 1)
modparam("tm", "auto_inv_100_reason", "Trying")

# --- RR ---
modparam("rr", "enable_full_lr", 1)
modparam("rr", "append_fromtag", 0)

# --- Registrar ---
modparam("registrar", "method_filtering", 1)
modparam("registrar", "max_expires", 3600)
modparam("registrar", "gruu_enabled", 0)

# --- NATHelper ---
modparam("nathelper", "natping_interval", 30)
modparam("nathelper", "ping_nated_only", 1)
modparam("nathelper", "sipping_bflag", 0)
modparam("nathelper", "sipping_from", "sip:pinger@kamailio.org")

# --- RTPEngine ---
modparam("rtpengine", "rtpengine_sock", "udp:rtpengine:22222")

# --- Dispatcher ---
modparam("dispatcher", "list_file", "/etc/kamailio/dispatcher.list")
modparam("dispatcher", "flags", 2)

# ==========================================================================
# Routing Logic
# ==========================================================================

request_route {
    route(REQINIT);
    route(NATDETECT);

    if (is_method("CANCEL")) {
        if (t_check_trans()) {
            t_relay();
        }
        exit;
    }

    if (!is_method("ACK")) {
        if(t_precheck_trans()) {
            t_check_trans();
            exit;
        }
        t_check_trans();
    }

    route(REGISTRAR);

    if ($rU==$null) {
        exit;
    }

    route(DISPATCH);
    route(RELAY);
}

route(REQINIT) {
    if (!mf_process_maxfwd_header("10")) {
        sl_send_reply("483","Too Many Hops");
        exit;
    }

    if(is_method("OPTIONS") && uri==myself && $rU==$null) {
        sl_send_reply("200","Keepalive");
        exit;
    }

    if(!sanity_check("1511", "7")) {
        xlog("Malformed SIP message from $si:$sp\n");
        exit;
    }
}

route(NATDETECT) {
    force_rport();
    if (nat_uac_test("19")) {
        if (is_method("REGISTER")) {
            fix_nated_register();
        } else {
            if(is_first_hop()) {
                set_contact_alias();
            }
        }
        setflag(5);
    }
}

route(REGISTRAR) {
    if (!is_method("REGISTER")) return;
    if(isflagset(5)) setbflag(0);
    if (!save("location")) sl_reply_error();
    exit;
}

route(DISPATCH) {
    if(!is_method("INVITE")) return;
    rtpengine_manage("replace-origin replace-session-connection ICE=remove");
    if(!ds_select_dst("1", "4")) {
        if (!lookup("location")) {
            sl_send_reply("404", "Not Found");
            exit;
        }
    }
}

route(RELAY) {
    if (is_method("INVITE|BYE|SUBSCRIBE|UPDATE")) {
        if(!t_is_set("failure_route")) t_on_failure("MANAGE_FAILURE");
    }
    if (!t_relay()) sl_reply_error();
    exit;
}

failure_route[MANAGE_FAILURE] {
    if (t_is_canceled()) exit;
    rtpengine_manage();
}
