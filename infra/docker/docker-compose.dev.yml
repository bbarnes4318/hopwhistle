version: '3.8'

services:
  # ============================================================================
  # Database & Cache
  # ============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: hopwhistle-postgres-dev
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-callfabric}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-callfabric_dev}
      POSTGRES_DB: ${POSTGRES_DB:-callfabric}
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-callfabric}']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - hopwhistle-network

  redis:
    image: redis:7-alpine
    container_name: hopwhistle-redis-dev
    ports:
      - '6379:6379'
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - hopwhistle-network

  # ============================================================================
  # Storage
  # ============================================================================
  minio:
    image: minio/minio:latest
    container_name: hopwhistle-minio-dev
    ports:
      - '9000:9000'
      - '9001:9001'
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hopwhistle-network

  # ============================================================================
  # Analytics
  # ============================================================================
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: hopwhistle-clickhouse-dev
    ports:
      - '8123:8123' # HTTP
      - '9002:9000' # Native (mapped to 9002 to avoid conflict with MinIO)
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-hopwhistle}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-}
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'http://localhost:8123/ping']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - hopwhistle-network

  # ============================================================================
  # Application Services
  # ============================================================================
  api:
    build:
      context: ../..
      dockerfile: apps/api/Dockerfile
    container_name: hopwhistle-api-dev
    ports:
      - '3001:3001'
    environment:
      NODE_ENV: development
      PORT: 3001
      HOST: 0.0.0.0
      DATABASE_URL: postgresql://${POSTGRES_USER:-callfabric}:${POSTGRES_PASSWORD:-callfabric_dev}@postgres:5432/${POSTGRES_DB:-callfabric}
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-dev-secret-change-in-production}
      RTPENGINE_URL: http://rtpengine:22222
      FREESWITCH_ESL_HOST: freeswitch
      FREESWITCH_ESL_PORT: 8021
      FREESWITCH_ESL_PASSWORD: ${FREESWITCH_ESL_PASSWORD:-ClueCon}
      S3_ENDPOINT: http://minio:9000
      S3_BUCKET: ${S3_BUCKET:-recordings}
      S3_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_FORCE_PATH_STYLE: 'true'
      CLICKHOUSE_URL: http://clickhouse:8123
      CLICKHOUSE_DATABASE: ${CLICKHOUSE_DB:-hopwhistle}
    volumes:
      - ../../:/workspace
      - api_node_modules:/workspace/node_modules
      - api_app_node_modules:/workspace/apps/api/node_modules
    working_dir: /workspace/apps/api
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - hopwhistle-network
    command: sh -c "pnpm install && pnpm dev"

  web:
    build:
      context: ../..
      dockerfile: apps/web/Dockerfile
    container_name: hopwhistle-web-dev
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:3001
      NEXT_PUBLIC_WS_URL: ws://localhost:3001
      NEXT_PUBLIC_API_KEY: ${API_KEY:-demo-key}
      NEXT_PUBLIC_APP_NAME: Hopwhistle
    volumes:
      - ../../:/workspace
      - web_node_modules:/workspace/node_modules
      - web_app_node_modules:/workspace/apps/web/node_modules
      - web_next:/workspace/apps/web/.next
    working_dir: /workspace/apps/web
    depends_on:
      - api
    networks:
      - hopwhistle-network
    command: sh -c "pnpm install && pnpm dev"

  worker:
    build:
      context: ../..
      dockerfile: apps/worker/Dockerfile
    container_name: hopwhistle-worker-dev
    ports:
      - '9091:9091'
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://${POSTGRES_USER:-callfabric}:${POSTGRES_PASSWORD:-callfabric_dev}@postgres:5432/${POSTGRES_DB:-callfabric}
      REDIS_URL: redis://redis:6379
      RTPENGINE_URL: http://rtpengine:22222
      FREESWITCH_ESL_HOST: freeswitch
      FREESWITCH_ESL_PORT: 8021
      FREESWITCH_ESL_PASSWORD: ${FREESWITCH_ESL_PASSWORD:-ClueCon}
      WORKER_CONCURRENCY: ${WORKER_CONCURRENCY:-5}
    volumes:
      - ../../:/workspace
      - worker_node_modules:/workspace/node_modules
      - worker_app_node_modules:/workspace/apps/worker/node_modules
    working_dir: /workspace/apps/worker
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - hopwhistle-network
    command: sh -c "pnpm install && pnpm dev"

  # ============================================================================
  # Telephony Infrastructure
  # ============================================================================
  freeswitch:
    build:
      context: ../..
      dockerfile: apps/freeswitch/Dockerfile
      args:
        SIGNALWIRE_TOKEN: ${SIGNALWIRE_TOKEN}
    container_name: hopwhistle-freeswitch-dev
    ports:
      - '5060:5060/udp'
      - '5060:5060/tcp'
      - '5080:5080/udp'
      - '5080:5080/tcp'
      - '5061:5061/tcp'
      - '8021:8021/tcp'
    environment:
      FREESWITCH_ESL_PASSWORD: ${FREESWITCH_ESL_PASSWORD:-ClueCon}
      API_URL: http://api:3001
      API_KEY: ${API_KEY:-demo-key}
      S3_ENDPOINT: http://minio:9000
      S3_BUCKET: ${S3_BUCKET:-recordings}
      S3_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_REGION: ${S3_REGION:-us-east-1}
      RECORDINGS_FORMAT: ${RECORDINGS_FORMAT:-wav}
      ENABLE_TLS: ${ENABLE_TLS:-false}
      ENABLE_SRTP: ${ENABLE_SRTP:-optional}
    volumes:
      - freeswitch_recordings:/recordings
      - freeswitch_conf:/usr/local/freeswitch/conf
    healthcheck:
      test: ['CMD', 'fs_cli', '-x', 'status']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      api:
        condition: service_started
    networks:
      - hopwhistle-network

  kamailio:
    build:
      context: ../..
      dockerfile: apps/kamailio/Dockerfile
    container_name: hopwhistle-kamailio-dev
    ports:
      - '5060:5060/udp'
      - '5060:5060/tcp'
      - '5061:5061/tcp'
    environment:
      FREESWITCH_NODES: ${FREESWITCH_NODES:-freeswitch:5080}
      RTPENGINE_SOCK: ${RTPENGINE_SOCK:-udp:rtpengine:22222}
      DB_URL: ${DB_URL:-}
    volumes:
      - kamailio_data:/var/run/kamailio
    healthcheck:
      test: ['CMD', 'kamctl', 'ping']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      freeswitch:
        condition: service_healthy
      rtpengine:
        condition: service_started
    networks:
      - hopwhistle-network

  rtpengine:
    build:
      context: ../..
      dockerfile: apps/rtpengine/Dockerfile
    container_name: hopwhistle-rtpengine-dev
    ports:
      - '22222:22222/udp'
      - '22222:22222/tcp'
      - '10000-20000:10000-20000/udp'
    environment:
      RTPENGINE_INTERFACE: ${RTPENGINE_INTERFACE:-auto}
    volumes:
      - rtpengine_recordings:/recordings
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    healthcheck:
      test: ['CMD', 'rtpengine-ctl', '-t', '127.0.0.1:9900', 'ping']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - hopwhistle-network

  # ============================================================================
  # Observability
  # ============================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: hopwhistle-prometheus-dev
    ports:
      - '9090:9090'
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=7d'
      - '--web.enable-lifecycle'
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'http://localhost:9090/-/healthy']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - hopwhistle-network

  grafana:
    image: grafana/grafana:latest
    container_name: hopwhistle-grafana-dev
    ports:
      - '3002:3000'
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: 'false'
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'http://localhost:3000/api/health']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - hopwhistle-network

volumes:
  postgres_data:
  redis_data:
  minio_data:
  clickhouse_data:
  clickhouse_logs:
  freeswitch_recordings:
  freeswitch_conf:
  kamailio_data:
  rtpengine_recordings:
  prometheus_data:
  grafana_data:
  api_node_modules:
  api_app_node_modules:
  web_node_modules:
  web_app_node_modules:
  web_next:
  worker_node_modules:
  worker_app_node_modules:

networks:
  hopwhistle-network:
    driver: bridge
